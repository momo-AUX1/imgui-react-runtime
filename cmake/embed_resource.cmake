cmake_minimum_required(VERSION 3.20)

set(ARG_INPUT "${INPUT}")
set(ARG_OUTPUT "${OUTPUT}")
set(ARG_SYMBOL "${SYMBOL}")
set(ARG_KEY "${KEY}")
set(ARG_ALIAS "${ALIAS}")

if(NOT ARG_INPUT)
  message(FATAL_ERROR "embed_resource.cmake missing required argument INPUT")
endif()
if(NOT ARG_OUTPUT)
  message(FATAL_ERROR "embed_resource.cmake missing required argument OUTPUT")
endif()
if(NOT ARG_SYMBOL)
  message(FATAL_ERROR "embed_resource.cmake missing required argument SYMBOL")
endif()
if(NOT ARG_KEY)
  message(FATAL_ERROR "embed_resource.cmake missing required argument KEY")
endif()

file(READ "${ARG_INPUT}" BINARY_CONTENT HEX)
string(REGEX MATCHALL ".." BYTE_LIST "${BINARY_CONTENT}")

set(BYTES_PER_LINE 12)
set(current_line "")
set(formatted_bytes "")
set(index 0)
foreach(byte IN LISTS BYTE_LIST)
  string(APPEND current_line "0x${byte}, ")
  math(EXPR index "${index} + 1")
  math(EXPR mod "${index} % ${BYTES_PER_LINE}")
  if(mod EQUAL 0)
    string(APPEND formatted_bytes "  ${current_line}\n")
    set(current_line "")
  endif()
endforeach()
if(NOT current_line STREQUAL "")
  string(APPEND formatted_bytes "  ${current_line}\n")
endif()

set(alias_registrations "")
if(ARG_ALIAS)
  foreach(alias_value IN LISTS ARG_ALIAS)
    if(NOT alias_value STREQUAL "")
      string(APPEND alias_registrations "    imgui_register_embedded_image(\"${alias_value}\", ${ARG_SYMBOL}, ${ARG_SYMBOL}_length);\n")
    endif()
  endforeach()
endif()

set(output_code "// Auto-generated by embed_resource.cmake. Do not edit manually.\n")
string(APPEND output_code "#include \"imgui-runtime.h\"\n\n")
string(APPEND output_code "namespace {\n")
string(APPEND output_code "static const unsigned char ${ARG_SYMBOL}[] = {\n${formatted_bytes}};\n")
string(APPEND output_code "static constexpr unsigned int ${ARG_SYMBOL}_length = static_cast<unsigned int>(sizeof(${ARG_SYMBOL}));\n\n")
string(APPEND output_code "struct EmbeddedRegister_${ARG_SYMBOL} {\n  EmbeddedRegister_${ARG_SYMBOL}() {\n    imgui_register_embedded_image(\"${ARG_KEY}\", ${ARG_SYMBOL}, ${ARG_SYMBOL}_length);\n${alias_registrations}  }\n};\n")
string(APPEND output_code "static EmbeddedRegister_${ARG_SYMBOL} g_embedded_${ARG_SYMBOL};\n}\n")

file(WRITE "${ARG_OUTPUT}" "${output_code}")
